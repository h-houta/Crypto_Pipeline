<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Lifecycle and Transformation - Crypto Pipeline</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #FF5722;
            padding-bottom: 10px;
        }
        .mermaid {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .description {
            background-color: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <h1>Data Lifecycle and Transformation</h1>
    
    <div class="description">
        <h2>Data Journey from Raw to Refined</h2>
        <p>This diagram shows how data transforms from raw API responses to business-ready analytical datasets.</p>
        <ul>
            <li><strong>Raw Layer:</strong> Direct API responses and Kafka messages</li>
            <li><strong>Bronze Layer:</strong> Raw storage in TimescaleDB</li>
            <li><strong>Silver Layer:</strong> Cleaned and standardized data</li>
            <li><strong>Gold Layer:</strong> Business-ready analytical models</li>
            <li><strong>Metrics:</strong> Performance and quality KPIs</li>
        </ul>
    </div>

    <div class="mermaid">
graph TD
    %% Styling
    classDef raw fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef bronze fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef silver fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    classDef gold fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef metric fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    
    subgraph "RAW DATA LAYER"
        R1["üì• Coinbase API Response<br/>{<br/>  'symbol': 'BTC-USD',<br/>  'price': '43521.23',<br/>  'volume': '1234.56',<br/>  'time': '2024-01-15T10:30:45Z',<br/>  'bid': '43520.00',<br/>  'ask': '43522.00'<br/>}"]:::raw
        
        R2["üì® Kafka Message<br/>{<br/>  'key': 'BTC-USD',<br/>  'value': {...price_data},<br/>  'timestamp': 1705315845000,<br/>  'partition': 0,<br/>  'offset': 12345<br/>}"]:::raw
    end
    
    subgraph "BRONZE LAYER - Raw Storage"
        B1["üóÑÔ∏è crypto.price_data<br/>TimescaleDB Hypertable<br/>‚Ä¢ symbol VARCHAR(20)<br/>‚Ä¢ price DECIMAL(18,8)<br/>‚Ä¢ volume DECIMAL(18,8)<br/>‚Ä¢ timestamp TIMESTAMPTZ<br/>‚Ä¢ bid DECIMAL(18,8)<br/>‚Ä¢ ask DECIMAL(18,8)<br/>‚Ä¢ created_at TIMESTAMPTZ"]:::bronze
        
        B2["üìä Data Volume<br/>‚Ä¢ ~360 records/hour/symbol<br/>‚Ä¢ ~8,640 records/day/symbol<br/>‚Ä¢ 10 symbols = 86,400 records/day<br/>‚Ä¢ Compressed after 7 days"]:::bronze
    end
    
    subgraph "SILVER LAYER - Cleaned & Standardized"
        S1["üîß stg_crypto_prices<br/>DBT Staging Model<br/>‚Ä¢ Renamed columns<br/>‚Ä¢ Type casting<br/>‚Ä¢ Null handling<br/>‚Ä¢ Deduplication<br/>‚Ä¢ Business logic applied"]:::silver
        
        S2["‚ú® Transformations<br/>‚Ä¢ timestamp ‚Üí time<br/>‚Ä¢ symbol standardization<br/>‚Ä¢ price validation (>0)<br/>‚Ä¢ volume validation (>=0)<br/>‚Ä¢ Remove test data"]:::silver
    end
    
    subgraph "GOLD LAYER - Business Ready"
        G1["üìà crypto_ohlcv_15min<br/>15-Minute Candlesticks<br/>‚Ä¢ period_start TIMESTAMP<br/>‚Ä¢ symbol VARCHAR<br/>‚Ä¢ open DECIMAL<br/>‚Ä¢ high DECIMAL<br/>‚Ä¢ low DECIMAL<br/>‚Ä¢ close DECIMAL<br/>‚Ä¢ volume DECIMAL<br/>‚Ä¢ trade_count INT"]:::gold
        
        G2["üíπ latest_crypto_prices<br/>Current Prices View<br/>‚Ä¢ symbol<br/>‚Ä¢ current_price<br/>‚Ä¢ 24h_change<br/>‚Ä¢ 24h_volume<br/>‚Ä¢ last_updated"]:::gold
        
        G3["üìä price_summary_15min<br/>Statistical Summary<br/>‚Ä¢ avg_price<br/>‚Ä¢ price_volatility<br/>‚Ä¢ volume_weighted_price<br/>‚Ä¢ price_momentum<br/>‚Ä¢ rsi_indicator"]:::gold
    end
    
    subgraph "METRICS & KPIs"
        M1["üìè Performance Metrics<br/>‚Ä¢ Messages/second: ~6<br/>‚Ä¢ Latency: <100ms<br/>‚Ä¢ Throughput: 500k msgs/day<br/>‚Ä¢ Storage: ~50MB/day"]:::metric
        
        M2["üí° Business Metrics<br/>‚Ä¢ Price accuracy: 99.9%<br/>‚Ä¢ Data completeness: 99.5%<br/>‚Ä¢ Freshness: <1 minute<br/>‚Ä¢ Availability: 99.9%"]:::metric
        
        M3["‚ö†Ô∏è Data Quality Metrics<br/>‚Ä¢ Null rate: <0.1%<br/>‚Ä¢ Duplicate rate: 0%<br/>‚Ä¢ Anomaly rate: <0.5%<br/>‚Ä¢ Gap detection: <1%"]:::metric
    end
    
    subgraph "DATA RETENTION POLICY"
        RP["üìÖ Retention Strategy<br/>‚Ä¢ RAW: 30 days (compressed after 7)<br/>‚Ä¢ OHLCV 15min: 1 year<br/>‚Ä¢ OHLCV 1hour: 2 years<br/>‚Ä¢ OHLCV 1day: Indefinite<br/>‚Ä¢ Backups: 90 days"]:::metric
    end
    
    %% Data Flow
    R1 -->|"HTTP Poll"| R2
    R2 -->|"Kafka Consumer"| B1
    B1 -->|"DBT Extract"| S1
    S1 -->|"Apply Rules"| S2
    S2 -->|"Aggregate"| G1
    S2 -->|"Latest"| G2
    S2 -->|"Statistics"| G3
    
    G1 --> M2
    G2 --> M2
    G3 --> M2
    
    B1 --> M1
    S2 --> M3
    
    B1 -.->|"Retention"| RP
    G1 -.->|"Archive"| RP
    
    %% Annotations
    R1 -.->|"10 sec interval"| R1
    B1 -.->|"Exactly-once"| B1
    S1 -.->|"Incremental"| S1
    G1 -.->|"30 min refresh"| G1
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default'
        });
    </script>
</body>
</html>
